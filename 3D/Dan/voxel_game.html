<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <title>Super Minecraft JS - Ultra Update</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #87CEEB;
            font-family: 'Segoe UI', sans-serif;
        }

        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            border: 2px solid white;
            transform: translate(-50%, -50%);
            pointer-events: none;
            mix-blend-mode: difference;
        }

        #hud {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
        }

        .slot {
            width: 50px;
            height: 50px;
            border: 2px solid #555;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
        }

        .slot.active {
            border-color: white;
            background: rgba(255, 255, 255, 0.2);
        }

        #instructions {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            pointer-events: none;
            border-radius: 5px;
            text-align: right;
        }
    </style>
</head>

<body>
    <div id="crosshair"></div>
    <div id="instructions">
        <b>W,A,S,D</b> - תנועה | <b>Space</b> - קפיצה<br>
        <b>קליק שמאלי</b> - שבירת בלוק | <b>קליק ימני</b> - בנייה<br>
        <b>1-4</b> - בחירת בלוקים
    </div>
    <div id="hud">
        <div class="slot active" data-block="1">דשא</div>
        <div class="slot" data-block="2">עץ</div>
        <div class="slot" data-block="3">חול</div>
        <div class="slot" data-block="4">אבן</div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

        // --- אתחול ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        scene.fog = new THREE.FogExp2(0x87CEEB, 0.05);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // --- אורות ---
        const ambient = new THREE.AmbientLight(0xffffff, 0.7);
        scene.add(ambient);
        const sun = new THREE.DirectionalLight(0xffffff, 1.2);
        sun.position.set(50, 100, 50);
        sun.castShadow = true;
        scene.add(sun);

        // --- חומרים וסוגי בלוקים ---
        const loader = new THREE.TextureLoader();
        const blockTypes = {
            1: { name: 'Grass', color: 0x567d46 },
            2: { name: 'Wood', color: 0x6e4f37 },
            3: { name: 'Sand', color: 0xd2b48c },
            4: { name: 'Stone', color: 0x808080 }
        };
        let selectedBlock = 1;

        const geometry = new THREE.BoxGeometry(1, 1, 1);
        const worldBlocks = []; // נשמור את כל האובייקטים לזיהוי קליקים

        // פונקציה ליצירת בלוק
        function createBlock(x, y, z, typeId) {
            const material = new THREE.MeshStandardMaterial({ color: blockTypes[typeId].color });
            const block = new THREE.Mesh(geometry, material);
            block.position.set(Math.round(x), Math.round(y), Math.round(z));
            block.castShadow = true;
            block.receiveShadow = true;
            block.userData.typeId = typeId;
            scene.add(block);
            worldBlocks.push(block);
        }

        // --- יצירת עולם ביומות (מדבר, יער, מישור) ---
        function generateWorld() {
            for (let x = -15; x < 15; x++) {
                for (let z = -15; z < 15; z++) {
                    let height = 1;
                    let type = 1; // דשא ברירת מחדל

                    // ביומה: מדבר
                    if (x > 5 && z > 5) {
                        type = 3; // חול
                        height = 1;
                    }
                    // ביומה: יער (קצת יותר גבוה)
                    else if (x < -5) {
                        type = 1;
                        height = Math.floor(Math.random() * 2) + 1;
                        // יצירת עץ מקרי
                        if (Math.random() > 0.95) {
                            for (let h = 0; h < 4; h++) createBlock(x, height + h, z, 2); // גזע
                        }
                    }

                    for (let y = 0; y < height; y++) {
                        createBlock(x, y, z, type);
                    }
                }
            }
        }
        generateWorld();

        // --- בקרת שחקן ---
        const controls = new PointerLockControls(camera, document.body);
        document.body.addEventListener('click', () => {
            if (!controls.isLocked) controls.lock();
        });

        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false, canJump = false;
        const velocity = new THREE.Vector3();
        const direction = new THREE.Vector3();

        document.addEventListener('keydown', (e) => {
            if (e.code === 'KeyW') moveForward = true;
            if (e.code === 'KeyS') moveBackward = true;
            if (e.code === 'KeyA') moveLeft = true;
            if (e.code === 'KeyD') moveRight = true;
            if (e.code === 'Space' && canJump) { velocity.y += 10; canJump = false; }
            if (e.key >= 1 && e.key <= 4) {
                selectedBlock = parseInt(e.key);
                document.querySelectorAll('.slot').forEach(s => s.classList.remove('active'));
                document.querySelector(`[data-block="${e.key}"]`).classList.add('active');
            }
        });
        document.addEventListener('keyup', (e) => {
            if (e.code === 'KeyW') moveForward = false;
            if (e.code === 'KeyS') moveBackward = false;
            if (e.code === 'KeyA') moveLeft = false;
            if (e.code === 'KeyD') moveRight = false;
        });

        // --- בנייה והריסה ---
        const raycaster = new THREE.Raycaster();
        document.addEventListener('mousedown', (e) => {
            if (!controls.isLocked) return;

            raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
            const intersects = raycaster.intersectObjects(worldBlocks);

            if (intersects.length > 0) {
                const intersect = intersects[0];

                if (e.button === 0) { // קליק שמאלי - הריסה
                    scene.remove(intersect.object);
                    worldBlocks.splice(worldBlocks.indexOf(intersect.object), 1);
                }
                else if (e.button === 2) { // קליק ימני - בנייה
                    const pos = intersect.object.position.clone().add(intersect.face.normal);
                    createBlock(pos.x, pos.y, pos.z, selectedBlock);
                }
            }
        });
        // ביטול תפריט קליק ימני
        document.addEventListener('contextmenu', e => e.preventDefault());

        camera.position.set(0, 5, 10);

        // --- לולאת משחק ---
        let prevTime = performance.now();
        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now();
            const delta = (time - prevTime) / 1000;

            if (controls.isLocked) {
                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;
                velocity.y -= 9.8 * 3.0 * delta;

                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize();

                if (moveForward || moveBackward) velocity.z -= direction.z * 100.0 * delta;
                if (moveLeft || moveRight) velocity.x -= direction.x * 100.0 * delta;

                controls.moveRight(-velocity.x * delta);
                controls.moveForward(-velocity.z * delta);
                camera.position.y += velocity.y * delta;

                if (camera.position.y < 2.5) {
                    velocity.y = 0;
                    camera.position.y = 2.5;
                    canJump = true;
                }
            }
            renderer.render(scene, camera);
            prevTime = time;
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>

</html>